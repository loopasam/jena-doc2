<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<!--

    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE- 2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->

  <title>Apache Jena - Tutorial - Manipulating SPARQL using ARQ</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="/jena-doc2/css/bootstrap.css" rel="stylesheet" media="screen">
  <link href="/jena-doc2/css/bootstrap-extension.css" rel="stylesheet" type="text/css">
  
  <script src="/jena-doc2//code.jquery.com/jquery.js"></script>
  <script src="/jena-doc2/js/jena-navigation.js" type="text/javascript"></script>
  <script src="/jena-doc2/js/bootstrap.min.js" type="text/javascript"></script>
  <script src="/jena-doc2/js/breadcrumbs.js" type="text/javascript"></script>
</head>

<body>



<nav class="navbar navbar-default" role="navigation">
<div class="container">
  <div class="navbar-header">
 	<a class="navbar-brand" href="/jena-doc2/index.html">
		<img class="logo-menu" src="/jena-doc2/images/jena-logo/jena-logo-notext-small.png" alt="jena logo">Apache Jena</a>
  </div>
  
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>


  <div class="collapse navbar-collapse navbar-ex1-collapse">
    <ul class="nav navbar-nav">



              <li id="homepage"><a href="/jena-doc2/index.html"><span class="glyphicon glyphicon glyphicon-home"></span> Home</a></li>
              <li id="download"><a href="/jena-doc2/download/index.html"><span class="glyphicon glyphicon-download-alt"></span> Download</a></li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-book"></span> Learn <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li class="dropdown-header">Tutorials</li>
                  <li><a href="/jena-doc2/tutorials/index.html">Overview</a></li>
                  <li><a href="/jena-doc2/tutorials/rdf_api.html">RDF core API tutorial</a></li>
                  <li><a href="/jena-doc2/tutorials/sparql.html">SPARQL tutorial</a></li>
                  <li><a href="/jena-doc2/documentation/query/manipulating_sparql_using_arq.html">Manipulating SPARQL using ARQ</a></li>
                  <li><a href="/jena-doc2/tutorials/using_jena_with_eclipse.html">Using Jena with Eclipse</a></li>
                  <li><a href="/jena-doc2/documentation/notes/index.html">How-To's</a></li>
                  <li class="divider"></li>
                  <li class="dropdown-header">References</li>
                  <li><a href="/jena-doc2/documentation/index.html">Overview</a></li>
                  <li><a href="/jena-doc2/documentation/javadoc/">Javadoc</a></li>
                  <li><a href="/jena-doc2/documentation/rdf/index.html">RDF API</a></li>
                  <li><a href="/jena-doc2/documentation/io/">RDF I/O</a></li>
                  <li><a href="/jena-doc2/documentation/query/index.html">ARQ (SPARQL)</a></li>
                  <li><a href="/jena-doc2/documentation/query/text-query.html">Text Search</a></li>
                  <li><a href="/jena-doc2/documentation/tdb/index.html">TDB</a></li>
                  <li><a href="/jena-doc2/documentation/sdb/index.html">SDB</a></li>
                  <li><a href="/jena-doc2/documentation/serving_data/index.html">Fuseki</a></li>
                  <li><a href="/jena-doc2/documentation/assembler/index.html">Assembler</a></li>
                  <li><a href="/jena-doc2/documentation/ontology/">Ontology API</a></li>
                  <li><a href="/jena-doc2/documentation/inference/index.html">Inference API</a></li>
                  <li><a href="/jena-doc2/documentation/tools/index.html">Command-line tools</a></li>
                </ul>
              </li>
              <li id="ask"><a href="/jena-doc2/help_and_support/index.html"><span class="glyphicon glyphicon-question-sign"></span> Ask</a></li>
              
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-bullhorn"></span> Get involved <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li><a href="/jena-doc2/getting_involved/index.html">Contribute</a></li>
                  <li><a href="/jena-doc2/help_and_support/bugs_and_suggestions.html">Report a bug</a></li>
                  <li class="divider"></li>
                  <li class="dropdown-header">Project</li>
                  <li><a href="/jena-doc2/about_jena/about.html">About Jena</a></li>
                  <li><a href="/jena-doc2/about_jena/roadmap.html">Roadmap</a></li>
                  <li><a href="/jena-doc2/about_jena/architecture.html">Architecture</a></li>
                  <li><a href="/jena-doc2/about_jena/team.html">Project team</a></li>
                  <li><a href="/jena-doc2/about_jena/contributions.html">Related projects</a></li>
                  <li class="divider"></li>
                  <li class="dropdown-header">ASF</li>
                  <li><a href="http://www.apache.org/">Apache Software Foundation</a></li>
                  <li><a href="http://www.apache.org/licenses/LICENSE-2.0">License</a></li>
                  <li><a href="http://www.apache.org/foundation/thanks.html">Thanks</a></li>
                  <li><a href="http://www.apache.org/foundation/sponsorship.html">Become a Sponsor</a></li>
                  <li><a href="http://www.apache.org/security/">Security</a></li>
                </ul>
              </li>

   
    </ul>
  </div>
</div>
</nav>


<div class="container">
	<div class="row">
	<div class="col-md-12">
	<div id="breadcrumbs"></div>
	<h1 class="title">Tutorial - Manipulating SPARQL using ARQ</h1>
  <p>When you've been working with SPARQL you quickly find that static
queries are restrictive. Maybe you want to vary a value, perhaps add a
filter, alter the limit, etc etc. Being an impatient sort you dive in to
the query string, and it works. But what about <a href="http://xkcd.com/327/">little Bobby
Tables</a>? And, even if you
sanitise your inputs, string manipulation is a fraught process and
syntax errors await you. Although it might seem harder than string
munging, the ARQ API is your friend in the long run.</p>
<p><em>Originally published on the <a href="http://researchrevealed.ilrt.bris.ac.uk/?p=35">Research Revealed project
blog</a></em></p>
<h2 id="inserting-values-simple-prepared-statements">Inserting values (simple prepared statements)</h2>
<p>Let's begin with something simple. Suppose we wanted to restrict the
following query to a particular person:</p>
<div class="codehilite"><pre>   <span class="n">select</span> <span class="o">*</span> <span class="p">{</span><span class="err"> </span><span class="o">?</span><span class="n">person</span> <span class="o">&lt;</span><span class="n">http</span><span class="o">:</span><span class="c1">//xmlns.com/foaf/0.1/name&gt; ?name }</span>
</pre></div>


<p><code>String#replaceAll</code> would work, but there is a safer way.
<code>QueryExecutionFactory</code> in most cases lets you supply a <code>QuerySolution</code>
with which you can prebind values.</p>
<div class="codehilite"><pre>   <span class="n">QuerySolutionMap</span> <span class="n">initialBinding</span> <span class="o">=</span> <span class="n">new</span> <span class="n">QuerySolutionMap</span><span class="p">();</span>
   <span class="n">initialBinding</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="n">personResource</span><span class="p">);</span>
   <span class="n">qe</span> <span class="o">=</span> <span class="n">QueryExecutionFactory</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">initialBinding</span><span class="p">);</span>
</pre></div>


<p>This is often much simpler than the string equivalent since you don't
have to escape quotes in literals. (Beware that this doesn't work for
<code>sparqlService</code>, which is a great shame. It would be nice to spend some
time remedying that.)</p>
<h2 id="making-a-query-from-scratch">Making a Query from Scratch</h2>
<p>The previously mentioned limitation is due to the fact that prebinding
doesn't actually change the query at all, but the execution of that
query. So what how do we really alter queries?</p>
<p>ARQ provides two ways to work with queries: at the syntax level (<code>Query</code>
and <code>Element</code>), or the algebra level (<code>Op</code>). The distinction is clear in
filters:</p>
<div class="codehilite"><pre>   <span class="n">SELECT</span><span class="err"> </span><span class="o">?</span><span class="n">s</span> <span class="p">{</span><span class="err"> </span><span class="o">?</span><span class="n">s</span> <span class="o">&lt;</span><span class="n">http</span><span class="o">:</span><span class="c1">//example.com/val&gt; ?val . FILTER ( ?val &lt; 20 ) }</span>
</pre></div>


<p>If you work at the syntax level you'll find that this looks (in pseudo
code) like:</p>
<div class="codehilite"><pre>   <span class="p">(</span><span class="n">GROUP</span> <span class="p">(</span><span class="n">PATTERN</span> <span class="p">(</span><span class="err"> </span><span class="o">?</span><span class="n">s</span> <span class="o">&lt;</span><span class="n">http</span><span class="o">:</span><span class="c1">//example.com/val&gt; ?val )) (FILTER ( &lt; ?val 20 ) ))</span>
</pre></div>


<p>That is there's a group containing a triple pattern and a filter, just
as you see in the query. The algebra is different, and we can see it
using <code>arq.qparse --print op</code></p>
<div class="codehilite"><pre>   <span class="err">$</span> <span class="n">java</span> <span class="n">arq</span><span class="p">.</span><span class="n">qparse</span> <span class="o">--</span><span class="n">print</span> <span class="n">op</span> <span class="err">&#39;</span><span class="n">SELECT</span><span class="err"> </span><span class="o">?</span><span class="n">s</span> <span class="p">{</span><span class="err"> </span><span class="o">?</span><span class="n">s</span> <span class="o">&lt;</span><span class="n">http</span><span class="o">:</span><span class="c1">//example.com/val&gt; ?val . FILTER ( ?val &lt; 20 ) }&#39;</span>
   <span class="p">(</span><span class="n">base</span> <span class="o">&lt;</span><span class="n">file</span><span class="o">:</span><span class="c1">///...&gt;</span>
       <span class="p">(</span><span class="n">project</span> <span class="p">(</span><span class="o">?</span><span class="n">s</span><span class="p">)</span>
           <span class="p">(</span><span class="n">filter</span> <span class="p">(</span><span class="o">&lt;</span><span class="err"> </span><span class="o">?</span><span class="n">val</span> <span class="mi">20</span><span class="p">)</span>
               <span class="p">(</span><span class="n">bgp</span> <span class="p">(</span><span class="n">triple</span><span class="err"> </span><span class="o">?</span><span class="n">s</span> <span class="o">&lt;</span><span class="n">http</span><span class="o">:</span><span class="c1">//example.com/val&gt; ?val)))))</span>
</pre></div>


<p>Here the filter contains the pattern, rather than sitting next to it.
This form makes it clear that the expression is filtering the pattern.</p>
<p>Let's create that query from scratch using ARQ. We begin with some
common pieces: the triple to match, and the expression for the filter.</p>
<div class="codehilite"><pre>   <span class="c1">// ?s ?p ?o .</span>
   <span class="n">Triple</span> <span class="n">pattern</span> <span class="o">=</span>
       <span class="n">Triple</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">Var</span><span class="p">.</span><span class="n">alloc</span><span class="p">(</span><span class="s">&quot;s&quot;</span><span class="p">),</span> <span class="n">Var</span><span class="p">.</span><span class="n">alloc</span><span class="p">(</span><span class="s">&quot;p&quot;</span><span class="p">),</span> <span class="n">Var</span><span class="p">.</span><span class="n">alloc</span><span class="p">(</span><span class="s">&quot;o&quot;</span><span class="p">));</span>
   <span class="c1">// ( ?s &lt; 20 )</span>
   <span class="n">Expr</span> <span class="n">e</span> <span class="o">=</span> <span class="n">new</span> <span class="n">E_LessThan</span><span class="p">(</span><span class="n">new</span> <span class="n">ExprVar</span><span class="p">(</span><span class="s">&quot;s&quot;</span><span class="p">),</span> <span class="n">new</span> <span class="n">NodeValueInteger</span><span class="p">(</span><span class="mi">20</span><span class="p">));</span>
</pre></div>


<p><code>Triple</code> should be familiar from jena. <code>Var</code> is an extension of <code>Node</code>
for variables. <code>Expr</code> is the root interface for expressions, those
things that appear in <code>FILTER</code> and <code>LET</code>.</p>
<p>First the syntax route:</p>
<div class="codehilite"><pre>   <span class="n">ElementTriplesBlock</span> <span class="n">block</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ElementTriplesBlock</span><span class="p">();</span> <span class="c1">// Make a BGP</span>
   <span class="n">block</span><span class="p">.</span><span class="n">addTriple</span><span class="p">(</span><span class="n">pattern</span><span class="p">);</span>                              <span class="c1">// Add our pattern match</span>
   <span class="n">ElementFilter</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ElementFilter</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>           <span class="c1">// Make a filter matching the expression</span>
   <span class="n">ElementGroup</span> <span class="n">body</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ElementGroup</span><span class="p">();</span>                <span class="c1">// Group our pattern match and filter</span>
   <span class="n">body</span><span class="p">.</span><span class="n">addElement</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
   <span class="n">body</span><span class="p">.</span><span class="n">addElement</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>

   <span class="n">Query</span> <span class="n">q</span> <span class="o">=</span> <span class="n">QueryFactory</span><span class="p">.</span><span class="n">make</span><span class="p">();</span>
   <span class="n">q</span><span class="p">.</span><span class="n">setQueryPattern</span><span class="p">(</span><span class="n">body</span><span class="p">);</span>                               <span class="c1">// Set the body of the query to our group</span>
   <span class="n">q</span><span class="p">.</span><span class="n">setQuerySelectType</span><span class="p">();</span>                                <span class="c1">// Make it a select query</span>
   <span class="n">q</span><span class="p">.</span><span class="n">addResultVar</span><span class="p">(</span><span class="s">&quot;s&quot;</span><span class="p">);</span>                                   <span class="c1">// Select ?s</span>
</pre></div>


<p>Now the algebra:</p>
<div class="codehilite"><pre>   <span class="n">Op</span> <span class="n">op</span><span class="p">;</span>
   <span class="n">BasicPattern</span> <span class="n">pat</span> <span class="o">=</span> <span class="n">new</span> <span class="n">BasicPattern</span><span class="p">();</span>                 <span class="c1">// Make a pattern</span>
   <span class="n">pat</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">pattern</span><span class="p">);</span>                                      <span class="c1">// Add our pattern match</span>
   <span class="n">op</span> <span class="o">=</span> <span class="n">new</span> <span class="n">OpBGP</span><span class="p">(</span><span class="n">pat</span><span class="p">);</span>                                   <span class="c1">// Make a BGP from this pattern</span>
   <span class="n">op</span> <span class="o">=</span> <span class="n">OpFilter</span><span class="p">.</span><span class="n">filter</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>                           <span class="c1">// Filter that pattern with our expression</span>
   <span class="n">op</span> <span class="o">=</span> <span class="n">new</span> <span class="n">OpProject</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">Arrays</span><span class="p">.</span><span class="n">asList</span><span class="p">(</span><span class="n">Var</span><span class="p">.</span><span class="n">alloc</span><span class="p">(</span><span class="s">&quot;s&quot;</span><span class="p">)));</span> <span class="c1">// Reduce to just ?s</span>
   <span class="n">Query</span> <span class="n">q</span> <span class="o">=</span> <span class="n">OpAsQuery</span><span class="p">.</span><span class="n">asQuery</span><span class="p">(</span><span class="n">op</span><span class="p">);</span>                       <span class="c1">// Convert to a query</span>
   <span class="n">q</span><span class="p">.</span><span class="n">setQuerySelectType</span><span class="p">();</span>                                <span class="c1">// Make is a select query</span>
</pre></div>


<p>Notice that the query form (<code>SELECT, CONSTRUCT, DESCRIBE, ASK</code>) isn't
part of the algebra, and we have to set this in the query (although
SELECT is the default). <code>FROM</code> and <code>FROM NAMED</code> are similarly absent.</p>
<h2 id="navigating-and-tinkering-visitors">Navigating and Tinkering: Visitors</h2>
<p>You can also look around the algebra and syntax using visitors. Start by
extending <code>OpVisitorBase</code> (<code>ElementVisitorBase</code>) which stubs out the
interface so you can concentrate on the parts of interest, then walk
using <code>OpWalker.walk(Op, OpVisitor)</code>
(<code>ElementWalker.walk(Element, ElementVisitor)</code>). These work bottom up.</p>
<p>For some alterations, like manipulating triple matches in place,
visitors will do the trick. They provide a simple way to get to the
right parts of the query, and you can alter the pattern backing BGPs in
both the algebra and syntax. Mutation isn't consistently available,
however, so don't depend on it.</p>
<h2 id="transforming-the-algebra">Transforming the Algebra</h2>
<p>So far there is no obvious advantage in using the algebra. The real
power is visible in transformers, which allow you to reorganise an
algebra completely. ARQ makes extensive use of transformations to
simplify and optimise query execution.</p>
<p>In Research Revealed I wrote some code to take a number of constraints
and produce a query. There were a number of ways to do this, but one way
I found was to generate ops from each constraint and join the results:</p>
<div class="codehilite"><pre>   <span class="k">for</span> <span class="p">(</span><span class="n">Constraint</span> <span class="n">con</span><span class="o">:</span> <span class="n">cons</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">op</span> <span class="o">=</span> <span class="n">OpJoin</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">consToOp</span><span class="p">(</span><span class="n">cons</span><span class="p">));</span> <span class="c1">// join</span>
   <span class="p">}</span>
</pre></div>


<p>The result was a perfectly correct mess, which is only barely readable
with just three conditions:</p>
<div class="codehilite"><pre>   <span class="p">(</span><span class="n">join</span>
       <span class="p">(</span><span class="n">join</span>
           <span class="p">(</span><span class="n">filter</span> <span class="p">(</span><span class="o">&lt;</span><span class="err"> </span><span class="o">?</span><span class="n">o0</span> <span class="mi">20</span><span class="p">)</span> <span class="p">(</span><span class="n">bgp</span> <span class="p">(</span><span class="n">triple</span><span class="err"> </span><span class="o">?</span><span class="n">s</span> <span class="o">&lt;</span><span class="n">urn</span><span class="o">:</span><span class="n">ex</span><span class="o">:</span><span class="n">prop0</span><span class="o">&gt;</span><span class="err"> </span><span class="o">?</span><span class="n">o0</span><span class="p">)))</span>
           <span class="p">(</span><span class="n">filter</span> <span class="p">(</span><span class="o">&lt;</span><span class="err"> </span><span class="o">?</span><span class="n">o1</span> <span class="mi">20</span><span class="p">)</span> <span class="p">(</span><span class="n">bgp</span> <span class="p">(</span><span class="n">triple</span><span class="err"> </span><span class="o">?</span><span class="n">s</span> <span class="o">&lt;</span><span class="n">urn</span><span class="o">:</span><span class="n">ex</span><span class="o">:</span><span class="n">prop1</span><span class="o">&gt;</span><span class="err"> </span><span class="o">?</span><span class="n">o1</span><span class="p">))))</span>
       <span class="p">(</span><span class="n">filter</span> <span class="p">(</span><span class="o">&lt;</span><span class="err"> </span><span class="o">?</span><span class="n">o2</span> <span class="mi">20</span><span class="p">)</span> <span class="p">(</span><span class="n">bgp</span> <span class="p">(</span><span class="n">triple</span><span class="err"> </span><span class="o">?</span><span class="n">s</span> <span class="o">&lt;</span><span class="n">urn</span><span class="o">:</span><span class="n">ex</span><span class="o">:</span><span class="n">prop2</span><span class="o">&gt;</span><span class="err"> </span><span class="o">?</span><span class="n">o2</span><span class="p">))))</span>
</pre></div>


<p>Each of the constraints is a filter on a bgp. This can be made much more
readable by moving the filters out, and merging the triple patterns. We
can do this with the following <code>Transform</code>:</p>
<div class="codehilite"><pre>   <span class="n">class</span> <span class="n">QueryCleaner</span> <span class="n">extends</span> <span class="n">TransformBase</span>
   <span class="p">{</span>
       <span class="err">@</span><span class="n">Override</span>
       <span class="n">public</span> <span class="n">Op</span> <span class="n">transform</span><span class="p">(</span><span class="n">OpJoin</span> <span class="n">join</span><span class="p">,</span> <span class="n">Op</span> <span class="n">left</span><span class="p">,</span> <span class="n">Op</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
           <span class="c1">// Bail if not of the right form</span>
           <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">left</span> <span class="n">instanceof</span> <span class="n">OpFilter</span> <span class="o">&amp;&amp;</span> <span class="n">right</span> <span class="n">instanceof</span> <span class="n">OpFilter</span><span class="p">))</span> <span class="k">return</span> <span class="n">join</span><span class="p">;</span>
           <span class="n">OpFilter</span> <span class="n">leftF</span> <span class="o">=</span> <span class="p">(</span><span class="n">OpFilter</span><span class="p">)</span> <span class="n">left</span><span class="p">;</span>
           <span class="n">OpFilter</span> <span class="n">rightF</span> <span class="o">=</span> <span class="p">(</span><span class="n">OpFilter</span><span class="p">)</span> <span class="n">right</span><span class="p">;</span>

           <span class="c1">// Add all of the triple matches to the LHS BGP</span>
           <span class="p">((</span><span class="n">OpBGP</span><span class="p">)</span> <span class="n">leftF</span><span class="p">.</span><span class="n">getSubOp</span><span class="p">()).</span><span class="n">getPattern</span><span class="p">().</span><span class="n">addAll</span><span class="p">(((</span><span class="n">OpBGP</span><span class="p">)</span> <span class="n">rightF</span><span class="p">.</span><span class="n">getSubOp</span><span class="p">()).</span><span class="n">getPattern</span><span class="p">());</span>
           <span class="c1">// Add the RHS filter to the LHS</span>
           <span class="n">leftF</span><span class="p">.</span><span class="n">getExprs</span><span class="p">().</span><span class="n">addAll</span><span class="p">(</span><span class="n">rightF</span><span class="p">.</span><span class="n">getExprs</span><span class="p">());</span>
           <span class="k">return</span> <span class="n">leftF</span><span class="p">;</span>
       <span class="p">}</span>
   <span class="p">}</span>
   <span class="p">...</span>
   <span class="n">op</span> <span class="o">=</span> <span class="n">Transformer</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="n">new</span> <span class="n">QueryCleaner</span><span class="p">(),</span> <span class="n">op</span><span class="p">);</span> <span class="c1">// clean query</span>
</pre></div>


<p>This looks for joins of the form:</p>
<div class="codehilite"><pre>   <span class="p">(</span><span class="n">join</span>
       <span class="p">(</span><span class="n">filter</span> <span class="p">(</span><span class="n">exp1</span><span class="p">)</span> <span class="p">(</span><span class="n">bgp1</span><span class="p">))</span>
       <span class="p">(</span><span class="n">filter</span> <span class="p">(</span><span class="n">exp2</span><span class="p">)</span> <span class="p">(</span><span class="n">bgp2</span><span class="p">)))</span>
</pre></div>


<p>And replaces it with:</p>
<div class="codehilite"><pre>   <span class="p">(</span><span class="n">filter</span> <span class="p">(</span><span class="n">exp1</span> <span class="o">&amp;&amp;</span> <span class="n">exp2</span><span class="p">)</span> <span class="p">(</span><span class="n">bgp1</span> <span class="o">&amp;&amp;</span> <span class="n">bgp2</span><span class="p">))</span>
</pre></div>


<p>As we go through the original query all joins are removed, and the
result is:</p>
<div class="codehilite"><pre>   <span class="p">(</span><span class="n">filter</span> <span class="p">(</span><span class="n">exprlist</span> <span class="p">(</span><span class="o">&lt;</span><span class="err"> </span><span class="o">?</span><span class="n">o0</span> <span class="mi">20</span><span class="p">)</span> <span class="p">(</span><span class="o">&lt;</span><span class="err"> </span><span class="o">?</span><span class="n">o1</span> <span class="mi">20</span><span class="p">)</span> <span class="p">(</span><span class="o">&lt;</span><span class="err"> </span><span class="o">?</span><span class="n">o2</span> <span class="mi">20</span><span class="p">))</span>
       <span class="p">(</span><span class="n">bgp</span>
           <span class="p">(</span><span class="n">triple</span><span class="err"> </span><span class="o">?</span><span class="n">s</span> <span class="o">&lt;</span><span class="n">urn</span><span class="o">:</span><span class="n">ex</span><span class="o">:</span><span class="n">prop0</span><span class="o">&gt;</span><span class="err"> </span><span class="o">?</span><span class="n">o0</span><span class="p">)</span>
           <span class="p">(</span><span class="n">triple</span><span class="err"> </span><span class="o">?</span><span class="n">s</span> <span class="o">&lt;</span><span class="n">urn</span><span class="o">:</span><span class="n">ex</span><span class="o">:</span><span class="n">prop1</span><span class="o">&gt;</span><span class="err"> </span><span class="o">?</span><span class="n">o1</span><span class="p">)</span>
           <span class="p">(</span><span class="n">triple</span><span class="err"> </span><span class="o">?</span><span class="n">s</span> <span class="o">&lt;</span><span class="n">urn</span><span class="o">:</span><span class="n">ex</span><span class="o">:</span><span class="n">prop2</span><span class="o">&gt;</span><span class="err"> </span><span class="o">?</span><span class="n">o2</span><span class="p">)</span>
   <span class="p">))</span>
</pre></div>


<p>That completes this brief introduction. There is much more to ARQ, of
course, but hopefully you now have a taste for what it can do.</p>
  </div>
</div>

</div><!--/.container -->

    <footer class="footer">
      <div class="container">
        <p>Copyright &copy; 2011&ndash;2013 The Apache Software Foundation, Licensed under
        the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>.
        </p>
        <p>
        Apache Jena, Jena, the Apache Jena project logo,
        Apache and the Apache feather logos are trademarks of The Apache Software Foundation.
        </p>
      </div>
  </footer>
      

</body>
</html>

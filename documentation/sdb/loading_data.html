<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<!--

    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE- 2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->

  <title>Apache Jena - SDB Loading data</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="/jena-doc2/css/bootstrap.css" rel="stylesheet" media="screen">
  <link href="/jena-doc2/css/bootstrap-extension.css" rel="stylesheet" type="text/css">
  
  <script src="/jena-doc2//code.jquery.com/jquery.js"></script>
  <script src="/jena-doc2/js/jena-navigation.js" type="text/javascript"></script>
  <script src="/jena-doc2/js/bootstrap.min.js" type="text/javascript"></script>
  <script src="/jena-doc2/js/breadcrumbs.js" type="text/javascript"></script>
</head>

<body>



<nav class="navbar navbar-default" role="navigation">
<div class="container">
  <div class="navbar-header">
 	<a class="navbar-brand" href="/jena-doc2/index.html">
		<img class="logo-menu" src="/jena-doc2/images/jena-logo/jena-logo-notext-small.png" alt="jena logo">Apache Jena</a>
  </div>
  
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>


  <div class="collapse navbar-collapse navbar-ex1-collapse">
    <ul class="nav navbar-nav">



              <li id="homepage"><a href="/jena-doc2/index.html"><span class="glyphicon glyphicon glyphicon-home"></span> Home</a></li>
              <li id="download"><a href="/jena-doc2/download/index.html"><span class="glyphicon glyphicon-download-alt"></span> Download</a></li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-book"></span> Learn <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li class="dropdown-header">Tutorials</li>
                  <li><a href="/jena-doc2/tutorials/index.html">Overview</a></li>
                  <li><a href="/jena-doc2/tutorials/rdf_api.html">RDF core API tutorial</a></li>
                  <li><a href="/jena-doc2/tutorials/sparql.html">SPARQL tutorial</a></li>
                  <li><a href="/jena-doc2/documentation/query/manipulating_sparql_using_arq.html">Manipulating SPARQL using ARQ</a></li>
                  <li><a href="/jena-doc2/tutorials/using_jena_with_eclipse.html">Using Jena with Eclipse</a></li>
                  <li><a href="/jena-doc2/documentation/notes/index.html">How-To's</a></li>
                  <li class="divider"></li>
                  <li class="dropdown-header">References</li>
                  <li><a href="/jena-doc2/documentation/index.html">Overview</a></li>
                  <li><a href="/jena-doc2/documentation/javadoc/">Javadoc</a></li>
                  <li><a href="/jena-doc2/documentation/rdf/index.html">RDF API</a></li>
                  <li><a href="/jena-doc2/documentation/io/">RDF I/O</a></li>
                  <li><a href="/jena-doc2/documentation/query/index.html">ARQ (SPARQL)</a></li>
                  <li><a href="/jena-doc2/documentation/query/text-query.html">Text Search</a></li>
                  <li><a href="/jena-doc2/documentation/tdb/index.html">TDB</a></li>
                  <li><a href="/jena-doc2/documentation/sdb/index.html">SDB</a></li>
                  <li><a href="/jena-doc2/documentation/serving_data/index.html">Fuseki</a></li>
                  <li><a href="/jena-doc2/documentation/assembler/index.html">Assembler</a></li>
                  <li><a href="/jena-doc2/documentation/ontology/">Ontology API</a></li>
                  <li><a href="/jena-doc2/documentation/inference/index.html">Inference API</a></li>
                  <li><a href="/jena-doc2/documentation/tools/index.html">Command-line tools</a></li>
                </ul>
              </li>
              <li id="ask"><a href="/jena-doc2/help_and_support/index.html"><span class="glyphicon glyphicon-question-sign"></span> Ask</a></li>
              
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-bullhorn"></span> Get involved <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li><a href="/jena-doc2/getting_involved/index.html">Contribute</a></li>
                  <li><a href="/jena-doc2/help_and_support/bugs_and_suggestions.html">Report a bug</a></li>
                  <li class="divider"></li>
                  <li class="dropdown-header">Project</li>
                  <li><a href="/jena-doc2/about_jena/about.html">About Jena</a></li>
                  <li><a href="/jena-doc2/about_jena/roadmap.html">Roadmap</a></li>
                  <li><a href="/jena-doc2/about_jena/architecture.html">Architecture</a></li>
                  <li><a href="/jena-doc2/about_jena/team.html">Project team</a></li>
                  <li><a href="/jena-doc2/about_jena/contributions.html">Related projects</a></li>
                  <li class="divider"></li>
                  <li class="dropdown-header">ASF</li>
                  <li><a href="http://www.apache.org/">Apache Software Foundation</a></li>
                  <li><a href="http://www.apache.org/licenses/LICENSE-2.0">License</a></li>
                  <li><a href="http://www.apache.org/foundation/thanks.html">Thanks</a></li>
                  <li><a href="http://www.apache.org/foundation/sponsorship.html">Become a Sponsor</a></li>
                  <li><a href="http://www.apache.org/security/">Security</a></li>
                </ul>
              </li>

   
    </ul>
  </div>
</div>
</nav>


<div class="container">
	<div class="row">
	<div class="col-md-12">
	<div id="breadcrumbs"></div>
	<h1 class="title">SDB Loading data</h1>
  <p>There are three ways to load data into SDB:</p>
<ol>
<li>Use the command utility
    <a href="commands.html#Loading_data" title="SDB/Commands">sdbload</a></li>
<li>Use one of the Jena <code>model.read</code> operations</li>
<li>Use the Jena <code>model.add</code></li>
</ol>
<p>The last one of these requires the application to signal the
beginning and end of batches.</p>
<h2 id="loading-with-modelread">Loading with <code>Model.read</code></h2>
<p>A Jena Model obtained from SDB via:</p>
<div class="codehilite"><pre><span class="n">SDBFactory</span><span class="p">.</span><span class="n">connectModel</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
</pre></div>


<p>will automatically bulk load data for each call of one of the
<code>Model.read</code> operations.</p>
<h2 id="loading-with-modeladd">Loading with <code>Model.add</code></h2>
<p>The <code>Model.add</code> operations, in any form or combination of forms,
whether loading a single statement, list of statements, or another
model, will invoke the bulk loader if previously notified before an
add operation.</p>
<p>You can also explicitly delimit bulk operations:</p>
<div class="codehilite"><pre> <span class="n">model</span><span class="p">.</span><span class="n">notifyEvent</span><span class="p">(</span><span class="n">GraphEvents</span><span class="p">.</span><span class="n">startRead</span><span class="p">)</span>
 <span class="p">...</span> <span class="k">do</span> <span class="n">add</span><span class="o">/</span><span class="n">remove</span> <span class="n">operations</span> <span class="p">...</span>
 <span class="n">model</span><span class="p">.</span><span class="n">notifyEvent</span><span class="p">(</span><span class="n">GraphEvents</span><span class="p">.</span><span class="n">finishRead</span><span class="p">)</span>
</pre></div>


<p><strong>Failing to notify the end of the operations will result in data loss</strong>.</p>
<p>A try/finally block can ensure that the finish is notified.</p>
<div class="codehilite"><pre> <span class="n">model</span><span class="p">.</span><span class="n">notifyEvent</span><span class="p">(</span><span class="n">GraphEvents</span><span class="p">.</span><span class="n">startRead</span><span class="p">)</span><span class="err"> </span><span class="p">;</span>
 <span class="n">try</span> <span class="p">{</span>
    <span class="p">...</span> <span class="k">do</span> <span class="n">add</span><span class="o">/</span><span class="n">remove</span> <span class="n">operations</span> <span class="p">...</span>
 <span class="p">}</span> <span class="n">finally</span> <span class="p">{</span>
   <span class="n">model</span><span class="p">.</span><span class="n">notifyEvent</span><span class="p">(</span><span class="n">GraphEvents</span><span class="p">.</span><span class="n">finishRead</span><span class="p">)</span><span class="err"> </span><span class="p">;</span>
 <span class="p">}</span>
</pre></div>


<p>The <code>model.read</code> operations do this automatically.</p>
<p>The bulk loader will automatically chunk large sequences of
additions to sizes appropriate to the underlying database. The bulk
loader is threaded with double-buffered; loading to the database
happens in parallel to the application thread and any RDF parsing.</p>
<h2 id="how-the-loader-works">How the loader works</h2>
<p>Loading consists of two phases: in the java VM, and on the database
itself. The SDB loader takes incoming triples and breaks them down
into components ready for the database. These prepared triples are
added to a queue for the database phase, which (by default) takes
place on a separate thread. When the number of triples reaches a
limit (default 20,000), or finish update is signalled, the triples
are passed to the database.</p>
<p>You can configure whether to use threading and the 'chunk size' --
the number of triples per load event -- via <code>StoreLoader</code>.</p>
<div class="codehilite"><pre><span class="n">Store</span> <span class="n">store</span><span class="p">;</span> <span class="c1">// SDB Store</span>
<span class="p">...</span>
<span class="n">store</span><span class="p">.</span><span class="n">getLoader</span><span class="p">().</span><span class="n">setChunkSize</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span> <span class="c1">//</span>
<span class="n">store</span><span class="p">.</span><span class="n">getLoader</span><span class="p">().</span><span class="n">setUseThreading</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span> <span class="c1">// Don&#39;t thread</span>
</pre></div>


<p>You should set these <em>before</em> the loader has been used.</p>
<p>Each loader sets up two temporary tables (<code>NNode</code> and <code>NTrip</code>) that
mirror <code>Nodes</code> and <code>Triples</code> tables. These tables are virtually
identical, except that a) they are not indexed and b) for the index
variant there is no index column for nodes.</p>
<p>When loading prepared triples -- triples that have been broken down
ready for the database -- are passed to the loader core (normally
running on a different thread). When the chunk size is reached, or
we are out of triples, the following happens:</p>
<ul>
<li>Prepared nodes are added in one go to <code>NNode</code>. Duplicate nodes
    within a chunk are suppressed on the java side (this is worth doing
    since they are quite common, e.g. properties).</li>
<li>Prepared triples are added in one go to <code>NTrip</code>.</li>
<li>New nodes are added to the node table (duplicate suppression is
    explained below).</li>
<li>New triples are added to the triple table (once again
    suppressing dupes). For the index case this involves joining on the
    node table to do a hash to index lookup.</li>
<li>We commit.</li>
<li>If anything goes wrong the transaction (the chunk) is rolled
    back, and an exception is thrown (or readied for throwing on the
    calling thread).</li>
</ul>
<p>Thus there are five calls to the database for every chunk. The
database handles almost all of the work uninterrupted (duplicate
suppression, hash to index lookup), which makes loading reasonably
quick.</p>
<h2 id="duplicate-suppression">Duplicate Suppression</h2>
<p>MySQL has a very useful <code>INSERT IGNORE</code>, which will keep going,
skipping an offending row if a uniqueness constraint is violated.
For other databases we need something else.</p>
<p>Having tried a number of options the best seems to be to <code>INSERT</code>
new items by <code>LEFT JOIN</code> new items to existing items, then
filtering <code>WHERE (existing item feature) IS NULL</code>. Specifically,
for the triple hash case (where no id lookups are needed):</p>
<div class="codehilite"><pre><span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">Triples</span>
<span class="n">SELECT</span> <span class="n">DISTINCT</span> <span class="n">NTrip</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="n">NTrip</span><span class="p">.</span><span class="n">p</span><span class="p">,</span> <span class="n">NTrip</span><span class="p">.</span><span class="n">o</span> <span class="o">--</span> <span class="n">DISTINCT</span> <span class="n">because</span> <span class="n">new</span> <span class="n">triples</span> <span class="n">may</span> <span class="n">contain</span> <span class="n">duplicates</span> <span class="p">(</span><span class="n">not</span> <span class="n">so</span> <span class="k">for</span> <span class="n">nodes</span><span class="p">)</span>
<span class="n">NTrip</span> <span class="n">LEFT</span> <span class="n">JOIN</span> <span class="n">Triples</span> <span class="n">ON</span> <span class="p">(</span><span class="n">NTrip</span><span class="p">.</span><span class="n">s</span><span class="o">=</span><span class="n">Triples</span><span class="p">.</span><span class="n">s</span> <span class="n">AND</span> <span class="n">NTrip</span><span class="p">.</span><span class="n">p</span><span class="o">=</span><span class="n">Triples</span><span class="p">.</span><span class="n">p</span> <span class="n">AND</span> <span class="n">NTrip</span><span class="p">.</span><span class="n">o</span><span class="o">=</span><span class="n">Triples</span><span class="p">.</span><span class="n">o</span><span class="p">)</span>
<span class="n">WHERE</span> <span class="n">Triples</span><span class="p">.</span><span class="n">s</span> <span class="n">IS</span> <span class="nb">NULL</span> <span class="n">OR</span> <span class="n">Triples</span><span class="p">.</span><span class="n">p</span> <span class="n">IS</span> <span class="nb">NULL</span> <span class="n">OR</span> <span class="n">Triples</span><span class="p">.</span><span class="n">o</span> <span class="n">IS</span> <span class="nb">NULL</span>
</pre></div>
  </div>
</div>

</div><!--/.container -->

    <footer class="footer">
      <div class="container">
        <p>Copyright &copy; 2011&ndash;2013 The Apache Software Foundation, Licensed under
        the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>.
        </p>
        <p>
        Apache Jena, Jena, the Apache Jena project logo,
        Apache and the Apache feather logos are trademarks of The Apache Software Foundation.
        </p>
      </div>
  </footer>
      

</body>
</html>
